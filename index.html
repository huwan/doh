<!DOCTYPE html>
<html>

<head>
    <title>Dream of Happiness</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <!-- Vendors-->
    <link rel="stylesheet" type="text/css" href="assets/vendors/bootstrap/grid.css">
    <link rel="stylesheet" type="text/css" href="assets/vendors/fullpagejs/fullpage.css" />
    <!-- App & fonts-->
    <link rel="stylesheet" type="text/css" href="https://fonts.googlefonts.cn/css?family=Roboto:300,400,500,700,900|Work+Sans:300,400,500,700">
    <link rel='stylesheet' href='https://fonts.googlefonts.cn/css?family=Lato:300'>
    <link rel="stylesheet" href="https://fonts.googlefonts.cn/css?family=Press+Start+2P">
    <link href="https://fonts.googlefonts.cn/css?family=Caveat:400,700" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="assets/css/coming-soon.css">
    <link rel="stylesheet" type="text/css" href="assets/css/particles.css">
    <link rel="stylesheet" type="text/css" href="assets/css/video.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css">
    <link rel="stylesheet" type="text/css" href="assets/css/console.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">


    <link rel="stylesheet" type="text/css" href="assets/css/custom.css">

    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <![endif]-->
</head>

<body>
    <div id="fullpage">

<!--         <div class="section" id="particles">
            <div id="particles-js" data-effect="default"></div>
        </div> -->

        <div class="section" id="start">
            <div class="container">
                <div class="title-doh">
                    Dream of <br> Happiness
                </div>

                <div class='console-container'>Dream of <span id='console-text'></span>
                  <div class='console-underscore' id='console'>&#95;</div>
                </div>
                <div class="text">
                    <div class="scroller">
                        <p>Scroll down or swipe up.</p>
                    </div>
                </div>

                <div class="author">
                    <p style="font-style: italic;">by</p>
                    <p>ZHANG Yujia</p>
                    <p>WAN Hu</p>
                </div>
            </div>
            <div id="particles-js" data-effect="default"></div>
        </div>

        <div class="section" id="putonahappyface">
            <div class="container">
                <div class="comming-soon-01">
                    <h3 class="comming-soon-01__title shimmer">Put on a happy face!</h3>
                    <p class="comming-soon-01__desc">Emotions are contagious. It's easier to catch an emotion than it is to catch a cold. What about catching the happiness? Yes, you can catch it and influence other emotions. For example, turn your sadness into happiness. In fact, sharing happiness can happen easier than you'd think. Join the Dream of Happiness experience, smile and keep smiling to pass on happiness from one to others. Let's go!</p>
                </div>
                <div class="text">
                    <div class="scroller">
                        <p>Scroll down or swipe up.</p>
                    </div>
                </div>
            </div>
                <div id="particles-js3" data-effect="nasa"></div>
        </div>

        <div class="section" id="emotionsvideo">
            <video id="myVideo" loop muted data-autoplay>
                <source src="assets/media/emotions.mp4" type="video/mp4">
                <!-- <source src="assets/media/emotions.webm" type="video/webm"> -->
            </video>
<!--             <div class="layer">
                <h1>fullPage.js videos</h1>
            </div> -->
        </div>

        <div class="section" id="animation">

            <div id="video_container">
                <video id="videoel" width="1080" height="720" preload="auto" loop playsinline autoplay>
                </video>
                <canvas id="video_overlay" width="1080" height="720"></canvas>
                <!-- <div id='emotion_chart'></div> -->
            </div>

            <div id="sketch-holder">
              <!-- Our sketch will go here! -->
            </div>
        </div>


        <div class="section" id="takeaphoto">
            <div id="camBox" style="width:100%;height:100%;background:white;background-image: radial-gradient(black 1px, transparent 0);background-size: 40px 40px;">
                <!--POPUP DIALOG BOX TO SHOW LIVE WEBCAM.-->
                <!-- <div class="revdivshowimg"> -->
                    <div id="webcamera" style="height:auto;text-align:center;margin:50px auto;"></div>
                    <p>
                        <input type="button" class="btn fa-input" value="&#xf030; Ok" id="btAddPicture" onclick="addCamPicture()" />
                        <input type="button" value="Cancel" onclick="document.getElementById('camBox').style.display = 'none'; Webcam.reset('#webcamera');" /> </p>
                    <input type="hidden" id="rowid" />
                    <input type="hidden" id="dataurl" />
                <!-- </div> -->
            </div>
            <div class="grid-container">
              <div class="photo_title">
                    <h1>Are you really happy?</h1>
                    <p>Let's take a photo and detect your perceived facial expressions<a href="#footnote-1" data-title="Personal data will not be kept." data-footnote="*"></a>.</p>
              </div>
              <div class="photo_main">
                    <canvas id="viewport" width="800" height="570"></canvas>
                    <div class="camera_button">
                        <button style="font-size:24px" id="takephotoicon" onclick="takeSnapshot(this)"><i class="fa fa-camera"></i> Take a photo</button>

                    </div>
              </div>
              <div class="photo_info">
                        <p>Detection result:</p>
                        <pre id="results"> </pre>
              </div>

            </div>
        </div>

        <div class="section" id="thankyou">
            <div class="gameover_container">
                    <div class="gameover">
                      <h1>Thank you!</h1>
                      <br />
                        <button id="restart" onclick="fullpage_api.moveSectionDown();">Click to restart.</button>
                    </div>
            </div>
                <!-- <div id="particles-js2" data-effect="star"></div> -->
        </div>


    </div>
    <!-- Vendors-->
    <script type="text/javascript" src="assets/vendors/_jquery/jquery.min.js"></script>
    <!-- <script type="text/javascript" src="assets/vendors/jquery.countdown/jquery.countdown.min.js"></script> -->
    <script type="text/javascript" src="assets/vendors/particles.js/particles.min.js"></script>
    <script type="text/javascript" src="assets/vendors/fullpagejs/fullpage.js"></script>
    <script type="text/javascript" src="assets/vendors/webcam/webcam.js"></script>
    <script type="text/javascript" src="assets/vendors/p5/p5.js"></script>

    <script type="text/javascript" src="assets/vendors/clmtrackr/utils.js"></script>
    <script type="text/javascript" src="assets/vendors/clmtrackr/clmtrackr.js"></script>
    <script type="text/javascript" src="assets/vendors/clmtrackr/model_pca_20_svm.js"></script>
    <script type="text/javascript" src="assets/vendors/clmtrackr/emotion_classifier.js"></script>
    <script type="text/javascript" src="assets/vendors/clmtrackr/emotionmodel.js"></script>
    <script type="text/javascript" src="assets/vendors/clmtrackr/d3.min.js"></script>
    <!-- main script-->
    <script type="text/javascript" src="assets/js/sketch.js"></script>
    <script type="text/javascript" src="assets/js/console.js"></script>
    <script type="text/javascript" src="assets/js/autorefresh.js"></script>
    <script type="text/javascript" src="assets/js/main.js"></script>


    <script type="text/javascript">
    takeSnapshot = function(oButton) {
            Webcam.set({
                width: 720,
                height: 480,
                image_format: 'jpeg',
                jpeg_quality: 100,
                flip_horiz: true,
                constraints: {
                    width: { exact: 720 },
                    height: { exact: 480 }
                }

            });
            Webcam.attach('#webcamera');
            document.getElementById('camBox').style.display = 'block';
            document.getElementById('rowid').value = oButton.id
        }
        // preload shutter audio clip
        var shutter = new Audio();
        shutter.autoplay = false;
        shutter.src = 'assets/media/snap.wav';


        var photo_canvas = document.getElementById('viewport'),
        photo_context = photo_canvas.getContext('2d');

        addCamPicture = function() {
        var rowid = document.getElementById('rowid').value;
        // play sound effect
        shutter.play();
        Webcam.snap(function(data_uri) {
            var subscriptionKey = "181889d6952f4fb0ad9b5bfff9215353";
            var uriBase = "https://dreamofhappiness.cognitiveservices.azure.com/face/v1.0/detect";
            // Request parameters.
            var params = {
                "detectionModel": "detection_01",
                "returnFaceAttributes": "emotion",
                "returnFaceId": "false"
            };

            base_image = new Image();
            base_image.src = data_uri;
            base_image.onload = function() {
                photo_context.drawImage(base_image, 40, 10, 720, 480);
                let data = photo_canvas.toDataURL('image/jpeg');
                fetch(data).then(res => res.blob()).then(blobData => {
                    $.post({
                        url: uriBase + "?" + $.param(params),
                        contentType: "application/octet-stream",
                        headers: {
                            'Ocp-Apim-Subscription-Key': subscriptionKey
                        },
                        processData: false,
                        data: blobData
                    }).done(function(data) {
                        var arrayLength = data.length;
                        if(arrayLength > 0) {
                            var photo_canvas = document.getElementById('viewport');
                            var new_photocontext = photo_canvas.getContext('2d');
                            new_photocontext.beginPath();
                            // Draw face rectangles into photo_canvas.
                            for(var i = 0; i < arrayLength; i++) {
                                var faceRectangle = data[i].faceRectangle;
                                new_photocontext.rect(faceRectangle.left, faceRectangle.top, faceRectangle.width, faceRectangle.height);
                            }
                            new_photocontext.lineWidth = 3;
                            new_photocontext.strokeStyle = 'red';
                            new_photocontext.stroke();
                            $("#results").text(JSON.stringify(data, null, 2));
                        } else {
                            $("#results").text("Sorry, no face detected.");
                            document.getElementById("takephotoicon").innerHTML="<i class='fa fa-camera'></i> Retake a photo";
                            document.getElementById('takephotoicon').style.display = 'initial';
                        }
                    }).fail(function(err) {
                        $("#results").text(JSON.stringify(err));
                    })
                });
            }
            document.getElementById('takephotoicon').style.display = 'none';

            // document.getElementById('div_' + rowid).innerHTML = 'Here is your image:<br />';
            // +'<img src="' + data_uri + '" id="" width="640px" height="480px" />';
            // '<img src="'+data_uri+'"/>';
        });
        document.getElementById('rowid').value = '';
        document.getElementById('camBox').style.display = 'none'; // HIDE THE POPUP DIALOG BOX.
        Webcam.reset('#webcamera');
    }
    </script>

    <script>
        document.getElementById("videoel").style.display = "none";
        var ishappy = 2;
        var vid = document.getElementById("videoel");
        var vid_width = vid.width;
        var vid_height = vid.height;
        var isStillPlaying = false;
        var overlay = document.getElementById('video_overlay');
        var overlayCC = overlay.getContext('2d');

        // Initializing values
        var isPlaying = true;

        // On video playing toggle values
        vid.onplaying = function() {
            isPlaying = true;
        };

        // On video pause toggle values
        vid.onpause = function() {
            isPlaying = false;
        };

        // Play video function
        function playVid() {
            if (vid.paused && !isPlaying) {
                vid.play();
            }
        }

        // Pause video function
        function pauseVid() {
            if (!vid.paused && isPlaying) {
                vid.pause();
            }
        }

        function indexOfMax(arr) {
            if (arr.length === 0) {
                return -1;
            }

            var max = arr[0].value;
            var maxIndex = 0;

            for (var i = 1; i < arr.length; i++) {
                if (arr[i].value > max) {
                    maxIndex = i;
                    max = arr[i].value;
                }
            }

            return maxIndex;
        }

        function adjustVideoProportions() {
            // resize overlay and video if proportions are different
            // keep same height, just change width
            var proportion = vid.videoWidth/vid.videoHeight;
            vid_width = Math.round(vid_height * proportion);
            vid.width = vid_width;
        }

        function gumSuccess( stream ) {
            // add camera stream if getUserMedia succeeded
            if ("srcObject" in vid) {
                vid.srcObject = stream;
            } else {
                vid.src = (window.URL && window.URL.createObjectURL(stream));
            }
            localstream = stream;
            vid.onloadedmetadata = function() {
                adjustVideoProportions();
                vid.play();
                // playVid();
            }
            vid.onresize = function() {
                adjustVideoProportions();
                if (trackingStarted) {
                    ctrack.stop();
                    ctrack.reset();
                    ctrack.start(vid);
                }
            }
        }

        function gumFail() {
            alert("There was some problem trying to fetch video from your webcam. If you have a webcam, please make sure to accept when the browser asks for access to your webcam.");
        }

        function startCamera() {
            navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
            window.URL = window.URL || window.webkitURL || window.msURL || window.mozURL;

            // check for camerasupport
            if (navigator.mediaDevices) {
                navigator.mediaDevices.getUserMedia({video : true}).then(gumSuccess).catch(gumFail);
            } else if (navigator.getUserMedia) {
                navigator.getUserMedia({video : true}, gumSuccess, gumFail);
            } else {
                alert("This demo depends on getUserMedia, which your browser does not seem to support. :(");
            }
        }
        vid.addEventListener("canplay", startVideo, false);

        pModel.shapeModel.nonRegularizedVectors.push(9);
        pModel.shapeModel.nonRegularizedVectors.push(11);

        var ctrack = new clm.tracker({useWebGL : true});
        ctrack.init(pModel);
        var trackingStarted = false;

        function startVideo() {
            vid.play();
            // playVid();
            // if (vid.paused && !isPlaying) {
            //     vid.play();
            //     }
            ctrack.start(vid);
            trackingStarted = true;

            drawLoop();
        }

        function stopVideo() {
          // vid.pause();
          // pauseVid();
            // if (!vid.paused && isPlaying) {
                vid.pause();
                vid.src = "";
                localstream.getTracks()[0].stop();
              // console.log("Video pause");
            // }
        }

        function drawLoop() {
            requestAnimFrame(drawLoop);
            overlayCC.clearRect(0, 0, vid_width * 2, vid_height * 2);
            //psrElement.innerHTML = "score :" + ctrack.getScore().toFixed(4);
            if (ctrack.getCurrentPosition()) {
                ctrack.draw(video_overlay);
            }

            var cp = ctrack.getCurrentParameters();

            var er = ec.meanPredict(cp);

            var isPassedThreshold = false;

            if (er) {
                var maxval_index = indexOfMax(er);
                    if(maxval_index == 3)
                    {
                        ishappy = 1;
                        // console.log("Happy");
                        setTimeout(function(){}, 100);
                    } else {
                        ishappy = 0;
                    }
            }
        }

        delete emotionModel["disgusted"];
        delete emotionModel["fear"];
        var ec = new emotionClassifier();
        ec.init(emotionModel);
        var emotionData = ec.getBlank();

    </script>

    <script type="text/javascript">
    $(function() {
        $('#fullpage').fullpage({
            licenseKey: 'OPEN-SOURCE-GPLV3-LICENSE',
            sectionsColor: ['#1b1b1b', '#1b1b1b', '#1b1b1b', '#1b1b1b', '#1b1b1b'],
            // anchors: ['1', '2', '3', '4', '5'],
            navigation: true,
            menu: '#menu',
            continuousVertical: true,
            // loopBottom:true,
            easingcss3: 'cubic-bezier(0.175, 0.885, 0.320, 1.275)',
            verticalCentered: true,
            afterRender: function() {
                //disabling scrolling up on page load if we are in the 1st section
                if($('.fp-section.active').index('.fp-section') === 0) {
                    fullpage_api.setAllowScrolling(false, 'up');
                }
            },
            afterLoad: function(origin, destination, direction) {
                var loadedSection = this;
                // console.log("origin: " + origin.index + " destination: " + destination.index );
                if(destination.index !== 0) {
                    //activating the scrolling up for any other section
                    fullpage_api.setAllowScrolling(true, 'up');
                } else {
                    //disabling the scrolling up when reaching 1st section
                    fullpage_api.setAllowScrolling(false, 'up');
                }
                if (destination.index == 3) {
                    startCamera();
                    startVideo();
                    restart_draw();
                }
                if (destination.index == 4) {
                    var frame_canvas = document.getElementById('viewport'),
                    frame_context = photo_canvas.getContext('2d');

                    var frame_background = new Image();
                    frame_background.src = "assets/media/background/newframe-800x570.png";

                    // Make sure the image is loaded first otherwise nothing will draw.
                    frame_background.onload = function(){
                        frame_context.fillStyle = "white";
                        frame_context.fillRect(0,0,frame_canvas.width, frame_canvas.height);
                        frame_context.drawImage(frame_background,0,0);
                        frame_context.beginPath();
                        frame_context.rect(40, 10, 720, 480);
                        frame_context.lineWidth = 1;
                        frame_context.strokeStyle = 'grey';
                        frame_context.stroke();
                    }
                    document.getElementById("takephotoicon").innerHTML="<i class='fa fa-camera'></i> Take a photo";
                    document.getElementById('takephotoicon').style.display = 'initial';

                    // stopVideo();

                }
            },
            onLeave: function(origin, destination, direction) {
                if(destination.index === 4) {
                    var photo_canvas = document.getElementById("viewport");
                    var newphoto_context = photo_canvas.getContext("2d");
                    newphoto_context.clearRect(0, 0, photo_canvas.width, photo_canvas.height);
                    document.getElementById('results').innerHTML = '';
                }
                if (origin.index === 3) {
                    stopVideo();
                }

            },
        });
    });
    </script>
    <script type="text/javascript">
        // Prevent "Confirm Form Resubmission"
    if ( window.history.replaceState ) {
      window.history.replaceState( null, null, window.location.href );
    }
    </script>
</body>

</html>

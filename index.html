<!DOCTYPE html>
<html>

<head>
    <title>Dream of Happiness</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <!-- Vendors-->
    <link rel="stylesheet" type="text/css" href="assets/vendors/bootstrap/grid.css">
    <link rel="stylesheet" type="text/css" href="assets/vendors/fullpagejs/fullpage.css" />
    <!-- App & fonts-->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700,900|Work+Sans:300,400,500,700">
    <!-- <link rel="stylesheet" type="text/css" href="assets/css/main.css"> -->
    <link rel="stylesheet" type="text/css" href="assets/css/coming-soon.css">
    <link rel="stylesheet" type="text/css" href="assets/css/particles.css">
    <!-- <link rel="stylesheet" type="text/css" href="assets/css/cloud.css"> -->
    <link rel="stylesheet" type="text/css" href="assets/css/video.css">
    <!-- <link rel="stylesheet" type="text/css" href="assets/css/webcam.css"> -->
    <link rel="stylesheet" type="text/css" href="assets/css/custom.css">
    <style>
    table,
    input {
        width: auto;
        font: 15px Calibri;
    }

    table,th,td,th {
        border: solid 1px #DDD;
        border-collapse: collapse;
        padding: 2px 3px;
        text-align: center;
        font-weight: normal;
    }

    #div_photoalpha {
        color: #fff;
    }

    #camBox {
        display: none;
        position: absolute;
        border: 0;
        top: 0;
        right: 0;
        left: 0;
        overflow-x: auto;
        overflow-y: hidden;
        z-index: 9999;
        background-color: rgba(239, 239, 239, .9);
        width: 100%;
        height: 100%;
        padding-top: 10px;
        text-align: center;
        cursor: pointer;
        -webkit-box-align: center;
        -webkit-box-orient: vertical;
        -webkit-box-pack: center;
        -webkit-transition: .2s opacity;
        -webkit-perspective: 1000
    }

    .revdivshowimg {
        width: 700px;
        top: 0;
        padding: 0;
        position: relative;
        margin: 0 auto;
        display: block;
        background-color: #fff;
        webkit-box-shadow: 6px 0 10px rgba(0, 0, 0, .2), -6px 0 10px rgba(0, 0, 0, .2);
        -moz-box-shadow: 6px 0 10px rgba(0, 0, 0, .2), -6px 0 10px rgba(0, 0, 0, .2);
        box-shadow: 6px 0 10px rgba(0, 0, 0, .2), -6px 0 10px rgba(0, 0, 0, .2);
        overflow: hidden;
        border-radius: 3px;
        color: #17293c
    }
    /*#results { float:right; margin:20px; padding:20px; border:1px solid; background:#ccc; }*/

    #results {
        display: block;
        font-family: monospace;
        white-space: pre;
        margin: 1em 0;
        color: white;
    }

    #video_container {position: absolute; top: 0; left: 0; border: 0
/*        position : fixed;
        top: 120;
        right: 120px;*/
        /*width : 240px;*/
        /*margin : 0px auto;*/
        /*float: right;*/
    }
    #video_overlay {
        position: absolute;
        top: 0px;
        left: 0px;
        -o-transform : scaleX(-1);
        -webkit-transform : scaleX(-1);
        transform : scaleX(-1);
        -ms-filter : fliph; /*IE*/
        filter : fliph; /*IE*/


    }

    #emotion_container {
        width: 600px;
    }

    #emotion_chart {
        margin: 0 auto;
        width : 400px;
    }

    /* d3 */
    .bar {
        fill : lightblue;
        fill-opacity : .9;
    }
    </style>
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <![endif]-->
</head>

<body>
    <div id="fullpage">

        <div class="section" id="section0">
            <div class="container">
                <div class="comming-soon-01">
                    <h3 class="comming-soon-01__title fade-in-text custom-cur">Dream of Happiness</h3>
                    <p class="comming-soon-01__desc">We are working on our website and will be online soon. Stay tuned!</p>
                    <!-- <p class="comming-soon-01__desc">We Are Almost Ready for Launch. Stay tuned!</p> -->
                    <div class="countdown__module hide" data-date="2021/06/10 00:00:00">
                        <p><span>%D</span> Days</p>
                        <p><span>%H</span> Hours</p>
                        <p><span>%M</span> Minutes</p>
                        <p><span>%S</span> Seconds</p>
                    </div>
                </div>
                <div class="text">
                    <div class="scroller">
                        <p>Scroll down or swipe up.</p>
                    </div>
                </div>
            </div>
            <div id="particles-js" data-effect="default"></div>
        </div>

        <div class="section" id="section2">
            <video id="myVideo" loop muted data-autoplay>
                <!-- <source src="assets/media/emotions.mp4" type="video/mp4"> -->
                <source src="assets/media/emotions.webm" type="video/webm">
            </video>
<!--             <div class="layer">
                <h1>fullPage.js videos</h1>
            </div> -->
        </div>

        <div class="section" id="animation">

            <div id="video_container">
                <video id="videoel" width="360" height="240" preload="auto" loop playsinline autoplay>
                </video>
                <canvas id="video_overlay" width="400" height="300"></canvas>
                <!-- <div id='emotion_chart'></div> -->
            </div>

            <div id="sketch-holder">
              <!-- Our sketch will go here! -->
            </div>
        </div>


        <div class="section" id="section1">
            <div class="container">
                <div id="camBox" style="width:100%;height:100%;">
                    <!--POPUP DIALOG BOX TO SHOW LIVE WEBCAM.-->
                    <div class="revdivshowimg" style="top:20%;text-align:center;margin:0 auto;">
                        <div id="webcamera" style="height:auto;text-align:center;margin:20px auto;"></div>
                        <p>
                            <input type="button" value="Ok" id="btAddPicture" onclick="addCamPicture()" />
                            <input type="button" value="Cancel" onclick="document.getElementById('camBox').style.display = 'none';" /> </p>
                        <input type="hidden" id="rowid" />
                        <input type="hidden" id="dataurl" /> </div>
                </div>
                <!-- <div id="results">Your captured image will appear here...</div> -->
                <div id="div_photoalpha">Your captured image will appear here...</div>
                <canvas id="viewport" width="320" height="240"></canvas>
                <div>
                    <p style="color:white">Emotions:</p> <pre id="results"> </pre>
                </div>
                <input type="button" value="Take a photo" id="photoalpha" onclick="takeSnapshot(this)" />
            </div>
            <!-- <div id="particles-js2" data-effect="star"></div> -->
        </div>

        <div class="section" id="section3">
            <div class="container">
                <div class="comming-soon-01">
                    <h3 class="comming-soon-01__title">Dream of Happiness</h3>
                </div>
                <!-- <div id="particles-js3" data-effect="nasa"></div> -->
            </div>
        </div>
    </div>
    <!-- Vendors-->
    <script type="text/javascript" src="assets/vendors/_jquery/jquery.min.js"></script>
    <script type="text/javascript" src="assets/vendors/jquery.countdown/jquery.countdown.min.js"></script>
    <script type="text/javascript" src="assets/vendors/particles.js/particles.min.js"></script>
    <script type="text/javascript" src="assets/vendors/fullpagejs/fullpage.js"></script>
    <script type="text/javascript" src="assets/vendors/webcam/webcam.js"></script>
    <script type="text/javascript" src="assets/vendors/p5/p5.js"></script>

    <script type="text/javascript" src="assets/vendors/clmtrackr/utils.js"></script>
    <script type="text/javascript" src="assets/vendors/clmtrackr/clmtrackr.js"></script>
    <script type="text/javascript" src="assets/vendors/clmtrackr/model_pca_20_svm.js"></script>
    <script type="text/javascript" src="assets/vendors/clmtrackr/emotion_classifier.js"></script>
    <script type="text/javascript" src="assets/vendors/clmtrackr/emotionmodel.js"></script>
    <script type="text/javascript" src="assets/vendors/clmtrackr/d3.min.js"></script>
    <!-- main script-->
    <script type="text/javascript" src="assets/js/main.js"></script>
    <script type="text/javascript" src="assets/js/sketch.js"></script>


    <script type="text/javascript">
    takeSnapshot = function(oButton) {
            Webcam.set({
                width: 640,
                height: 480,
                image_format: 'jpeg',
                jpeg_quality: 100,
                flip_horiz: true
            });
            Webcam.attach('#webcamera');
            document.getElementById('camBox').style.display = 'block';
            document.getElementById('rowid').value = oButton.id
        }
        // preload shutter audio clip
        var shutter = new Audio();
        shutter.autoplay = false;
        shutter.src = 'assets/media/snap.wav';
        var photo_canvas = document.getElementById('viewport'),
        photo_context = photo_canvas.getContext('2d');
        
        addCamPicture = function() {
        var rowid = document.getElementById('rowid').value;
        // play sound effect
        shutter.play();
        Webcam.snap(function(data_uri) {
            var subscriptionKey = "181889d6952f4fb0ad9b5bfff9215353";
            var uriBase = "https://dreamofhappiness.cognitiveservices.azure.com/face/v1.0/detect";
            // Request parameters.
            var params = {
                "detectionModel": "detection_01",
                "returnFaceAttributes": "emotion",
                "returnFaceId": "false"
            };
            base_image = new Image();
            base_image.src = data_uri;
            base_image.onload = function() {
                photo_context.drawImage(base_image, 0, 0, 320, 240);
                let data = photo_canvas.toDataURL('image/jpeg');
                fetch(data).then(res => res.blob()).then(blobData => {
                    $.post({
                        url: uriBase + "?" + $.param(params),
                        contentType: "application/octet-stream",
                        headers: {
                            'Ocp-Apim-Subscription-Key': subscriptionKey
                        },
                        processData: false,
                        data: blobData
                    }).done(function(data) {
                        var arrayLength = data.length;
                        if(arrayLength > 0) {
                            var photo_canvas = document.getElementById('viewport');
                            var new_photocontext = photo_canvas.getContext('2d');
                            new_photocontext.beginPath();
                            // Draw face rectangles into photo_canvas.
                            for(var i = 0; i < arrayLength; i++) {
                                var faceRectangle = data[i].faceRectangle;
                                new_photocontext.rect(faceRectangle.left, faceRectangle.top, faceRectangle.width, faceRectangle.height);
                            }
                            new_photocontext.lineWidth = 3;
                            new_photocontext.strokeStyle = 'red';
                            new_photocontext.stroke();
                        }
                        $("#results").text(JSON.stringify(data, null, 2));
                    }).fail(function(err) {
                        $("#results").text(JSON.stringify(err));
                    })
                });
            }
            document.getElementById('div_' + rowid).innerHTML = 'Here is your image:<br />';
            // +'<img src="' + data_uri + '" id="" width="640px" height="480px" />';
            // '<img src="'+data_uri+'"/>';
        });
        document.getElementById('rowid').value = '';
        document.getElementById('camBox').style.display = 'none'; // HIDE THE POPUP DIALOG BOX.
        Webcam.reset('#webcamera');
    }
    </script>

        <script>
            // document.getElementById("videoel").style.display = "none";
            var ishappy = 2;
            var vid = document.getElementById("videoel");
            var vid_width = vid.width;
            var vid_height = vid.height;
            var isStillPlaying = false;
            var overlay = document.getElementById('video_overlay');
            var overlayCC = overlay.getContext('2d');

            function indexOfMax(arr) {
                if (arr.length === 0) {
                    return -1;
                }

                var max = arr[0].value;
                var maxIndex = 0;

                for (var i = 1; i < arr.length; i++) {
                    if (arr[i].value > max) {
                        maxIndex = i;
                        max = arr[i].value;
                    }
                }

                return maxIndex;
            }

            function adjustVideoProportions() {
                // resize overlay and video if proportions are different
                // keep same height, just change width
                var proportion = vid.videoWidth/vid.videoHeight;
                vid_width = Math.round(vid_height * proportion);
                vid.width = vid_width;
            }

            function gumSuccess( stream ) {
                // add camera stream if getUserMedia succeeded
                if ("srcObject" in vid) {
                    vid.srcObject = stream;
                } else {
                    vid.src = (window.URL && window.URL.createObjectURL(stream));
                }
                localstream = stream;
                vid.onloadedmetadata = function() {
                    adjustVideoProportions();
                    vid.play();
                }
                vid.onresize = function() {
                    adjustVideoProportions();
                    if (trackingStarted) {
                        ctrack.stop();
                        ctrack.reset();
                        ctrack.start(vid);
                    }
                }
            }

            function gumFail() {
                alert("There was some problem trying to fetch video from your webcam. If you have a webcam, please make sure to accept when the browser asks for access to your webcam.");
            }

            function startCamera() {
                navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
                window.URL = window.URL || window.webkitURL || window.msURL || window.mozURL;

                // check for camerasupport
                if (navigator.mediaDevices) {
                    navigator.mediaDevices.getUserMedia({video : true}).then(gumSuccess).catch(gumFail);
                } else if (navigator.getUserMedia) {
                    navigator.getUserMedia({video : true}, gumSuccess, gumFail);
                } else {
                    alert("This demo depends on getUserMedia, which your browser does not seem to support. :(");
                }
            }
            vid.addEventListener("canplay", startVideo, false);

            pModel.shapeModel.nonRegularizedVectors.push(9);
            pModel.shapeModel.nonRegularizedVectors.push(11);

            var ctrack = new clm.tracker({useWebGL : true});
            ctrack.init(pModel);
            var trackingStarted = false;

            function startVideo() {
                vid.play();
                console.log("Video play");

                ctrack.start(vid);
                trackingStarted = true;
                // Tone.Transport.start();

                drawLoop();
            }

            function stopVideo() {
              vid.pause();
              vid.src = "";
              localstream.getTracks()[0].stop();
              console.log("Video pause");
            }

            function drawLoop() {
                requestAnimFrame(drawLoop);
                overlayCC.clearRect(0, 0, vid_width, vid_height);
                //psrElement.innerHTML = "score :" + ctrack.getScore().toFixed(4);
                if (ctrack.getCurrentPosition()) {
                    ctrack.draw(video_overlay);
                }

                var cp = ctrack.getCurrentParameters();

                var er = ec.meanPredict(cp);

                var isPassedThreshold = false;

                if (er) {
                    var maxval_index = indexOfMax(er);
                        if(maxval_index == 3)
                        {
                            ishappy = 1;
                            // console.log("Happy");
                            setTimeout(function(){}, 100);
                        } else {
                            ishappy = 0;
                        }
                }
            }
                    // updateData(er);
                  //   var maxval_index = indexOfMax(er);
                  //   if (er[maxval_index].value>0.4){
                  //       if(maxval_index == 0 || maxval_index == 1)
                  //       {
                  //           if (!isStillPlaying){
                  //               isStillPlaying = true;
                  //               camDetect = 0;
                  // console.log("Sad!");
                  //               setTimeout(function(){
                  //                   isStillPlaying = false;
                  //               camDetect = 2;
                  //               }, 2000);
                  //           }
                  //       }

                  //       if(maxval_index == 3)
                  //       {
                  //           if (!isStillPlaying){
                  //               isStillPlaying = true;
                  //               camDetect = 1;
                  //                   console.log("Happy");
                  //               setTimeout(function(){
                  //                   isStillPlaying = false;
                  //               // camDetect = 2;
                  //               }, 2000);

                  //           }
                  //   }
                // }



            delete emotionModel["disgusted"];
            delete emotionModel["fear"];
            var ec = new emotionClassifier();
            ec.init(emotionModel);
            var emotionData = ec.getBlank();

                /************ d3 code for barchart *****************/

                // var margin = {top : 20, right : 20, bottom : 10, left : 40},
                //     width = 400 - margin.left - margin.right,
                //     height = 100 - margin.top - margin.bottom;

                // var barWidth = 30;

                // var formatPercent = d3.format(".0%");

                // var x = d3.scale.linear()
                //     .domain([0, ec.getEmotions().length]).range([margin.left, width+margin.left]);

                // var y = d3.scale.linear()
                //     .domain([0,1]).range([0, height]);

                // var svg = d3.select("#emotion_chart").append("svg")
                //     .attr("width", width + margin.left + margin.right)
                //     .attr("height", height + margin.top + margin.bottom)

                // svg.selectAll("rect").
                //     data(emotionData).
                //     enter().
                //     append("svg:rect").
                //     attr("x", function(datum, index) { return x(index); }).
                //     attr("y", function(datum) { return height - y(datum.value); }).
                //     attr("height", function(datum) { return y(datum.value); }).
                //     attr("width", barWidth).
                //     attr("fill", "#2d578b");

                // svg.selectAll("text.labels").
                //     data(emotionData).
                //     enter().
                //     append("svg:text").
                //     attr("x", function(datum, index) { return x(index) + barWidth; }).
                //     attr("y", function(datum) { return height - y(datum.value); }).
                //     attr("dx", -barWidth/2).
                //     attr("dy", "1.2em").
                //     attr("text-anchor", "middle").
                //     text(function(datum) { return datum.value;}).
                //     attr("fill", "white").
                //     attr("class", "labels");

                // svg.selectAll("text.yAxis").
                //     data(emotionData).
                //     enter().append("svg:text").
                //     attr("x", function(datum, index) { return x(index) + barWidth; }).
                //     attr("y", height).
                //     attr("dx", -barWidth/2).
                //     attr("text-anchor", "middle").
                //     attr("style", "font-size: 12").
                //     text(function(datum) { return datum.emotion;}).
                //     attr("transform", "translate(0, 18)").
                //     attr("class", "yAxis");

                // function updateData(data) {
                //     // update
                //     var rects = svg.selectAll("rect")
                //         .data(data)
                //         .attr("y", function(datum) { return height - y(datum.value); })
                //         .attr("height", function(datum) { return y(datum.value); });
                //     var texts = svg.selectAll("text.labels")
                //         .data(data)
                //         .attr("y", function(datum) { return height - y(datum.value); })
                //         .text(function(datum) { return datum.value.toFixed(1);});

                //     // enter
                //     rects.enter().append("svg:rect");
                //     texts.enter().append("svg:text");

                //     // exit
                //     rects.exit().remove();
                //     texts.exit().remove();
                // }

        </script>

    <script type="text/javascript">
    $(function() {
        $('#fullpage').fullpage({
            licenseKey: 'OPEN-SOURCE-GPLV3-LICENSE',
            sectionsColor: ['#1b1b1b', '#1b1b1b', '#1b1b1b', '#1b1b1b', '#1b1b1b'],
            // anchors: ['1', '2', '3', '4', '5'],
            navigation: true,
            menu: '#menu',
            continuousVertical: true,
            // loopBottom:true,
            easingcss3: 'cubic-bezier(0.175, 0.885, 0.320, 1.275)',
            verticalCentered: true,
            afterRender: function() {
                //disabling scrolling up on page load if we are in the 1st section
                if($('.fp-section.active').index('.fp-section') === 0) {
                    fullpage_api.setAllowScrolling(false, 'up');
                }
            },
            afterLoad: function(origin, destination, direction) {
                var loadedSection = this;
                // console.log("origin: " + origin.index + " destination: " + destination.index );
                if(destination.index !== 0) {
                    //activating the scrolling up for any other section
                    fullpage_api.setAllowScrolling(true, 'up');
                } else {
                    //disabling the scrolling up when reaching 1st section
                    fullpage_api.setAllowScrolling(false, 'up');
                }
                if (destination.index == 2) {
                    startCamera();
                    startVideo();
                    restart_draw();
                }
            },
            onLeave: function(origin, destination, direction) {
                if(origin.index === 2 && destination.index === 3) {
                    document.getElementById('div_photoalpha').innerHTML = 'Your captured image will appear here...';
                    var photo_canvas = document.getElementById("viewport");
                    var newphoto_context = photo_canvas.getContext("2d");
                    newphoto_context.clearRect(0, 0, photo_canvas.width, photo_canvas.height);
                    document.getElementById('results').innerHTML = '';
                }
                if (origin.index === 2) {
                    stopVideo();
                }
            },
        });
    });
    </script>
    <!-- <script type="text/javascript" src="assets/js/webcam.js"></script> -->
</body>

</html>